@model IEnumerable<AracKiralamaPortal.Models.Car>

@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Araç Yönetimi";
}

<style>
    body {
        background: #0b0f1a;
    }

    .neon-card {
        background: #111827;
        border-radius: 18px;
        border: 1px solid rgba(0,245,255,.15);
        box-shadow: 0 0 30px rgba(0,245,255,.08);
    }

    .neon-title {
        color: #00f5ff;
        text-shadow: 0 0 10px rgba(0,245,255,.6);
        font-weight: 700;
    }

    .neon-btn {
        text-decoration:none;
        background: linear-gradient(135deg, #00f5ff, #a855f7);
        border: none;
        color: #000;
        font-weight: 700;
        border-radius: 12px;
        padding: 10px 22px;
        box-shadow: 0 0 25px rgba(0,245,255,.5);
        transition: .3s;
    }

        .neon-btn:hover {
            text-decoration:none;
            color:white;
            transform: translateY(-1px);
            box-shadow: 0 0 35px rgba(168,85,247,.9);
        }

    table {
        color: #e5e7eb;
    }

        table thead th {
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        table tbody tr {
            color:white;
            transition: background .3s ease;
            border-radius: 12px;
        }

            table tbody tr:hover {
                background: rgba(0,245,255,.08);
            }

    .status-badge {
        padding: 6px 16px;
        border-radius: 999px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        user-select: none;
        display: inline-block;
        transition: .3s;
        box-shadow: 0 0 10px rgba(0,0,0,.3);
    }

    .available {
        color:white;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        box-shadow: 0 0 12px rgba(34,197,94,.6);
    }

    .not-available {
        color:white;
        background: linear-gradient(135deg, #ef4444, #b91c1c);
        box-shadow: 0 0 12px rgba(239,68,68,.6);
    }

    .car-image {
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,.1);
        box-shadow: 0 0 12px rgba(0,0,0,.4);
        max-width: 120px;
    }

    .action-btn {
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 13px;
    }

    .neon-input {
        background: #0f172a;
        border: 1px solid rgba(0,245,255,.3);
        color: #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 0 15px rgba(0,245,255,.15);
        padding:10px;
    }

        .neon-input:focus {
            outline: none;
            border-color: #00f5ff;
            box-shadow: 0 0 25px rgba(0,245,255,.6);
            background: #020617;
            color: white;
        }

    .col-md-3 {
            margin:10px;
        }

</style>

<div class="container mt-5 mb-5">

    <div class="card neon-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="neon-title mb-0">
                    <i class="bi bi-car-front-fill me-2"></i> Araçlar
                </h4>

                <div>
                    <button id="advancedFilterBtn" class="neon-btn">Gelişmiş Filtreleme</button>
                    <a href="/Car/Create" class="neon-btn">+ Yeni Araç</a>
                </div>
            </div>

            <div id="advancedFilterPanel" class="mb-4 p-3" style="display:none; background:#111827; border-radius:12px; border:1px solid rgba(0,245,255,.2);">
                <div class="row g-3">
                    <div class="col-md-3">
                        <input type="text" id="filterModelAdv" class="form-control neon-input" placeholder="Model">
                    </div>
                    <div class="col-md-3">
                        <select id="filterBrandAdv" class="form-select neon-input">
                            <option value="">Tüm Markalar</option>
                            @foreach (var brand in Model.Select(x => x.Brand?.Name).Distinct())
                            {
                                <option value="@brand">@brand</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="filterVehicleTypeAdv" class="form-select neon-input">
                            <option value="">Tüm Tipler</option>
                            @foreach (var type in Model.Select(x => x.VehicleType?.Name).Distinct())
                            {
                                <option value="@type">@type</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="filterVehicleSubTypeAdv" class="form-select neon-input">
                            <option value="">Tüm Alt Tipler</option>
                            @foreach (var subType in Model.Select(x => x.VehicleSubType?.Name).Distinct())
                            {
                                <option value="@subType">@subType</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-2">
                        <input type="number" id="filterYearMin" class="form-control neon-input" placeholder="Min Yıl">
                    </div>
                    <div class="col-md-2">
                        <input type="number" id="filterYearMax" class="form-control neon-input" placeholder="Max Yıl">
                    </div>
                    <div class="col-md-2">
                        <input type="number" id="filterPriceMin" class="form-control neon-input" placeholder="Min Fiyat">
                    </div>
                    <div class="col-md-2">
                        <input type="number" id="filterPriceMax" class="form-control neon-input" placeholder="Max Fiyat">
                    </div>

                    <div class="col-md-2">
                        <select id="filterStatusAdv" class="form-select neon-input">
                            <option value="">Tüm Durumlar</option>
                            <option value="Müsait">Müsait</option>
                            <option value="Müsait Değil">Müsait Değil</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <button id="applyAdvancedFilter" class="neon-btn w-100">Uygula</button>
                    </div>
                </div>
            </div>

        </div>

        <table class="table table-borderless align-middle">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Model</th>
                    <th>Yıl</th>
                    <th>Fiyat</th>
                    <th>Marka</th>
                    <th>Araç Tipi</th>
                    <th>Araç Alt Tipi</th>
                    <th>Durum</th>
                    <th>Resim</th>
                    <th class="text-end">İşlemler</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in Model)
                {
                    <tr id="row_@item.Id">
                        <td>@item.Id</td>
                        <td>@item.Model</td>
                        <td>@item.Year</td>
                        <td>@item.Price ₺</td>
                        <td>@item.Brand?.Name</td>
                        <td>@item.VehicleType?.Name</td>
                        <td>@item.VehicleSubType?.Name</td>

                        <td>
                            <span id="status_@item.Id"
                                  class="status-badge @(item.isAvailable ? "available" : "not-available")"
                                  onclick="carAvailable(@item.Id)">
                                @(item.isAvailable ? "Müsait" : "Müsait Değil")
                            </span>
                        </td>

                        <td>
                            @if (!string.IsNullOrEmpty(item.ImagePath))
                            {
                                <img src="@item.ImagePath" class="car-image" />
                            }
                            else
                            {
                                <span class="text-muted">Resim yok</span>
                            }
                        </td>

                        <td class="text-end">
                            <a href="/Car/Edit/@item.Id"
                               class="btn btn-warning btn-sm action-btn">
                                Düzenle
                            </a>

                            <button class="btn btn-danger btn-sm action-btn"
                                    onclick="deleteCar(@item.Id)">
                                Sil
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

    </div>
</div>

<script>
    function deleteCar(id) {
        if (!confirm("Bu aracı silmek istediğine emin misin?")) return;

        $.ajax({
            type: "POST",
            url: "/Car/Delete/" + id,
            success: function () {
                $("#row_" + id).fadeOut(400);
            },
            error: function () {
                alert("Silme işleminde hata oluştu!");
            }
        });
    }

    function carAvailable(id) {
        $.ajax({
            type: "POST",
            url: "/Car/UpdateAvailability",
            data: { id: id },
            success: function (res) {
                if (!res.success) return;

                let badge = $("#status_" + id);

                if (res.isAvailable) {
                    badge.text("Müsait")
                         .removeClass("not-available")
                         .addClass("available");
                } else {
                    badge.text("Müsait Değil")
                         .removeClass("available")
                         .addClass("not-available");
                }
            },
            error: function () {
                alert("Durum güncellenirken hata oluştu!");
            }
        });
    }

        document.addEventListener("DOMContentLoaded", function () {

        function normalizeTR(text) {
            return text
                .toLocaleLowerCase("tr-TR")
                .trim();
        }

        function applyFilters() {

            const modelFilter  = normalizeTR($("#filterModel").val());
            const brandFilter  = normalizeTR($("#filterBrand").val());
            const statusFilter = normalizeTR($("#filterStatus").val());

            $("tbody tr").each(function () {

                const tds = $(this).find("td");

                const model  = normalizeTR(tds.eq(1).text());
                const brand  = normalizeTR(tds.eq(4).text());
                const status = normalizeTR(tds.eq(5).find(".status-badge").text());

                const matchModel  = modelFilter === "" || model.includes(modelFilter);
                const matchBrand  = brandFilter === "" || brand === brandFilter;
                const matchStatus = statusFilter === "" || status === statusFilter;

                $(this).toggle(matchModel && matchBrand && matchStatus);
            });
        }

        $("#filterModel").on("input", applyFilters);
        $("#filterBrand").on("change", applyFilters);
        $("#filterStatus").on("change", applyFilters);
    });

        document.getElementById("advancedFilterBtn").addEventListener("click", function() {
        const panel = document.getElementById("advancedFilterPanel");
        panel.style.display = panel.style.display === "none" ? "block" : "none";
    });

    document.getElementById("applyAdvancedFilter").addEventListener("click", function() {
        const modelFilter = $("#filterModelAdv").val().toLowerCase().trim();
        const brandFilter = $("#filterBrandAdv").val().toLowerCase().trim();
        const typeFilter = $("#filterVehicleTypeAdv").val().toLowerCase().trim();
        const subTypeFilter = $("#filterVehicleSubTypeAdv").val().toLowerCase().trim();
        const statusFilter = $("#filterStatusAdv").val().toLowerCase().trim();
        const yearMin = parseInt($("#filterYearMin").val()) || 0;
        const yearMax = parseInt($("#filterYearMax").val()) || Infinity;
        const priceMin = parseFloat($("#filterPriceMin").val()) || 0;
        const priceMax = parseFloat($("#filterPriceMax").val()) || Infinity;

        $("tbody tr").each(function() {
            const tds = $(this).find("td");
            const model = tds.eq(1).text().toLowerCase();
            const brand = tds.eq(4).text().toLowerCase();
            const type = tds.eq(5).text().toLowerCase();
            const subType = tds.eq(6).text().toLowerCase();
            const status = tds.eq(7).text().toLowerCase();
            const year = parseInt(tds.eq(2).text()) || 0;
            const price = parseFloat(tds.eq(3).text()) || 0;

            const match =
                (modelFilter === "" || model.includes(modelFilter)) &&
                (brandFilter === "" || brand === brandFilter) &&
                (typeFilter === "" || type === typeFilter) &&
                (subTypeFilter === "" || subType === subTypeFilter) &&
                (statusFilter === "" || status === statusFilter) &&
                year >= yearMin && year <= yearMax &&
                price >= priceMin && price <= priceMax;

            $(this).toggle(match);
        });
    });
</script>
